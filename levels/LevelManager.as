package levels{

	import actors.*;

	import util.*;
	import com.*;
	import tileMapper.*;

	import flash.display.MovieClip;
	import flash.display.Stage;
	import flash.events.*;
	import flash.ui.*;
	import flash.utils.Timer;
	import flash.events.TimerEvent;

	public class LevelManager extends MovieClip {
		public static var mapClip=new MovieClip  ;
		public static var stageRef:Stage;
		public static var mapCode;

		public static var tileTypes=new Array("f","a","b","c","d","e");
		public static var tileClings=new Array(true,false,true,true,true,true);

		public static function loadLevel() {
			InteractiveTile.resetTiles();
			loadMap();
			setHeroPosition();

			stageRef.addChild(LevelManager.mapClip);
			ScreenRect.createScreenRect(new Array(mapClip),640,480);
			stageRef.addEventListener(Event.ENTER_FRAME, VCamHandler);

		}

		public static function loadMap() {
			mapCode="31:71:333333333333333333333333333333333333333333333333333333333333333333333333444434444344443444434444333333333333333333333444434444344443444434444334444344443444434444344443333333333333333333334444344443444434444344443300003000030000300003000033333333333333333333300003000030000300003000033000030000300003000030000333333333333333333333000030000300003000030000330000300003000030000300003333333333333333333330000300003000030000300003333333333333333333333333334444344443444434444333333333333333333333333333444444444444444444444444344443444434444344443444444444444444444444444335555555555555555555555553000030000300003000035555555555555555555555553300000000000000000000000030000300003000030000300000000000000000000000033000000000000000000000000300003000030000300003000000000000000000000000333333333333333303333030003333333333333333333330003033330333333333333333344443333333333333333300044444444444444444444400033333333333333333444433444433333333333333333000555555555555555555555000333333333333333334444330000";
			mapCode+="333333333333333330000000000000000000000000003333333333333333300003300003333333333333333300000000000000000000000000033333333333333333000033000033333333333333333000303333333330000333303000333333333333333330000333333333333333333333330003333333333300003333330003333333333333333333333344444444444444444444400034444333333333334444300044444444444444444444433555555555555555555555000344443333333333344443000555555555555555555555330000000000000000000000003000033333333333000030000000000000000000000003300000000000000000000000030000333333333330000300000000000000000000000033333030333303333033330333300003333333333300003333033330333303333030333333333333333333333333333333333333333333333333333333333333333333333333333344443444434444344443444433333333333333333333344443444434444344443444433444434444344443444434444333333333333333333333444434444344443444434444330000300003000030000300003333333333333333333330000300003000030000300003300003000030000300003000033333333333333333333300003000030000300003000033000030000300003";
			mapCode+="000030000333333333333333333333000030000300003000030000333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333330000000000000000000000000000000(63,20)";
			//mapCode="15:20:333333333333333333333333333333333333333333333333333333333333333333333333333333333300000000000000003333000000000000000033330000000000000000333300000000000000003333000000000000000033330000000000000000333300000000000000003333000000000000000033330000000000000000333333333333333333333333333333333333333333000000000000000(9,12)";
			TileMap.removeTiles(mapClip);
			TileMap.createTileMap(mapCode,32,tileTypes,tileClings,"Tile");
			TileMap.addTiles(mapClip);
		}
		public static function setHeroPosition() {
			var ind1=mapCode.indexOf("(")+1;
			var ind2=mapCode.indexOf(",",ind1);
			var startX=parseInt(mapCode.substring(ind1,ind2));
			ind1=ind2+1;
			ind2=mapCode.indexOf(")");
			var startY=parseInt(mapCode.substring(ind1,ind2));


			trace(startX+" "+startY);

			Unit.currentUnit.mxpos=Unit.partnerUnit.mxpos=startX;
			Unit.currentUnit.mypos=Unit.partnerUnit.mypos=startY;
			Unit.currentUnit.x=startX+.5*TileMap.TILE_SIZE;
			Unit.currentUnit.y=startY+.5*TileMap.TILE_SIZE;
			Unit.partnerUnit.x=startX+.5*TileMap.TILE_SIZE;
			Unit.partnerUnit.y=startY+.5*TileMap.TILE_SIZE;

			mapClip.addChild(Unit.currentUnit);
			mapClip.addChild(Unit.partnerUnit);

		}

		public static function VCamHandler(e) {
			ScreenRect.setX(Unit.currentUnit.x-640/2);
			ScreenRect.setY(Math.max(Unit.currentUnit.y-480/2,0));
			//ScreenRect.easeScreen(new Point(Unit.xpos - WIDTH / 2, Unit.ypos - HEIGHT));
			if (ScreenRect.getX()<0) {
				ScreenRect.setX(0);
			}
			if (ScreenRect.getY()<0) {
				ScreenRect.setY(0);
			}
			var firstSep=mapCode.indexOf(":");
			var secSep=mapCode.indexOf(":",firstSep+1);


			//var mapWidth=parseInt(mapCode.substring(firstSep+1,secSep));
			//var mapHeight=parseInt(mapCode.substring(0,firstSep));
			var mapWidth = 71;
			var mapHeight = 31;
			if (ScreenRect.getX()+640>mapWidth*32) {
				ScreenRect.setX(mapWidth*32-640);
			}
			if (ScreenRect.getY()+480>mapHeight*32) {
				ScreenRect.setY(mapHeight*32-480);
			}


		}

	}
}