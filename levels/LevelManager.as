package levels{

	import actors.*;

	import util.*;
	import com.*;
	import tileMapper.*;

	import flash.display.MovieClip;
	import flash.display.Stage;
	import flash.events.*;
	import flash.ui.*;
	import flash.utils.Timer;
	import flash.events.TimerEvent;

	public class LevelManager extends MovieClip {
		public static var mapClip=new MovieClip  ;
		public static var stageRef:Stage;
		public static var mapCode;

		public static var tileTypes=new Array("p","n","p","n","n","n");
		public static var tileClings=new Array(false,false,false,true,true,false);

		public static function loadLevel() {
			InteractiveTile.resetTiles();
			loadMap();
			setHeroPosition();

			stageRef.addChild(LevelManager.mapClip);
			ScreenRect.createScreenRect(new Array(mapClip),640,480);
			stageRef.addEventListener(Event.ENTER_FRAME, VCamHandler);

		}

		public static function loadMap() {
			/*mapCode = "31:71:33333333333333333333333333333333333333333333333333333333333333333333333344443444434444344443444433333333333333333333344443444434444344443444433444434444344443444434444333333333333333333333444434444344443444434444330000300003000030000300003333333333333333333330000300003000030000300003300003000030000300003000033333333333333333333300003000030000300003000033000030000300003000030000333333333333333333333000030000300003000030000333333333333333333333333333444434444344443444433333333333333333333333333344444444444444444444444434444344443444434444344444444444444444444444433555555555555555555555555300003000030000300003555555555555555555555555330000000000000000000000003000030000300003000030000000000000000000000003300000000000000000000000030000300003000030000300000000000000000000000033333333333333330333303000333333333333333333333000303333033333333333333334444333333333333333330004444444444444444444440003333333333333333344443344443333333333333333300055555555555555555555500033333333333333333444433";
			mapCode+="000033333333333333333000000000000000000000000000333333333333333330000330000333333333333333330000000000000000000000000003333333333333333300003300003333333333333333300030333333333000033330300033333333333333333000033333333333333333333333000344443333330000344443000333333333333333333333334444444444444444444440003444433333333333444430004444444444444444444443355555555555555555555500030000333333333330000300055555555555555555555533000000000000000000000000300003333333333300003000000000000000000000000330000000000000000000000003000033333333333000030000000000000000000000003333303033330333303333033333333333333333333333333303333033330333303033333444434444344443444434444333333333333333333333444434444344443444434444334444344443444434444344443333333333333333333334444344443444434444344443300003000030000300003000033333333333333333333300003000030000300003000033000030000300003000030000333333333333333333333000030000300003000030000330000300003000030000300003333333333333333333330000300003000030000300003333333333";
			mapCode+="3333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333330000000000000000000000000000000(66,20)";
			*/
			mapCode="15:20:333333333333333333333333333333333333333333444444444444444433334444444444444444333300000000000000003333000000000000000033330000333003330000333300003330033300003333000033300333000033330000333003330000333300003330033300003333000000000000000033330000000000000000333333333333333333333333333333333333333333000000000000000(9,12)";
			TileMap.removeTiles(mapClip);
			TileMap.createTileMap(mapCode,32,tileTypes,tileClings,"Tile");
			TileMap.addTiles(mapClip);
		}
		public static function setHeroPosition() {
			var ind1=mapCode.indexOf("(")+1;
			var ind2=mapCode.indexOf(",",ind1);
			var startX=parseInt(mapCode.substring(ind1,ind2));
			ind1=ind2+1;
			ind2=mapCode.indexOf(")");
			var startY=parseInt(mapCode.substring(ind1,ind2));


			//trace(startX+" "+startY);

			Unit.currentUnit.mxpos=Unit.partnerUnit.mxpos=startX*TileMap.TILE_SIZE;//+.5*TileMap.TILE_SIZE;
			Unit.currentUnit.mypos=Unit.partnerUnit.mypos=startY*TileMap.TILE_SIZE;//+.5*TileMap.TILE_SIZE;
			Unit.currentUnit.x=startX*TileMap.TILE_SIZE;//startX+.5*TileMap.TILE_SIZE;
			Unit.currentUnit.y=startY*TileMap.TILE_SIZE;//startY+.5*TileMap.TILE_SIZE;
			Unit.partnerUnit.x=startX*TileMap.TILE_SIZE;//startX+.5*TileMap.TILE_SIZE;
			Unit.partnerUnit.y=startY*TileMap.TILE_SIZE;//startY+.5*TileMap.TILE_SIZE;


			//trace(Unit.currentUnit.x + " " + Unit.currentUnit.y);
			mapClip.addChild(Unit.currentUnit);
			mapClip.addChild(Unit.partnerUnit);

		}

		public static function VCamHandler(e) {
			ScreenRect.setX(Unit.currentUnit.x-640/2);
			ScreenRect.setY(Math.max(Unit.currentUnit.y-480/2,0));
			//ScreenRect.easeScreen(new Point(Unit.xpos - WIDTH / 2, Unit.ypos - HEIGHT));
			if (ScreenRect.getX()<0) {
				ScreenRect.setX(0);
			}
			if (ScreenRect.getY()<0) {
				ScreenRect.setY(0);
			}
			//var firstSep=mapCode.indexOf(":");
			//var secSep=mapCode.indexOf(":",firstSep+1);


			//var mapWidth=parseInt(mapCode.substring(firstSep+1,secSep));
			//var mapHeight=parseInt(mapCode.substring(0,firstSep));
			var mapWidth = 20;
			var mapHeight = 15;
			if (ScreenRect.getX()+640>mapWidth*32) {
				ScreenRect.setX(mapWidth*32-640);
			}
			if (ScreenRect.getY()+480>mapHeight*32) {
				ScreenRect.setY(mapHeight*32-480);
			}


		}

	}
}